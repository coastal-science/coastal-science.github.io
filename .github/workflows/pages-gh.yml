# Workflow for building and deploying Hugo site (Production + Preview)
name: Deploy Hugo site - Production and Preview
run-name: ${{ github.event_name == 'pull_request' && format('Preview deployment for PR #{0}', github.event.pull_request.number) || format('Build/deploy Pages/Production - {0}', github.ref_name) }}

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main", "gha-patch-reusable-workflow"]

  # Runs on pull requests for Deploy Preview Links
  pull_request:
    types: [opened, synchronize, reopened]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  
  workflow_call: # allows reusing the workflow
    # inputs:
    #   target:
    #     required: false
    #     type: string
    # secrets:
    #   token:
    #     required: false
        
# env:
#   CONTAINER_PROJECT: "coastal-science.github.io" # "rcg-containers" # repo name dynamically extracted from `github.repository` by removing `github.owner`

# Allow one concurrent deployment
concurrency:
  group: ${{ github.repository }}-coastal-pages-${{ github.event_name == 'pull_request' && github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  generate-timestamp:
    permissions: {}
    runs-on: ubuntu-latest
    steps:
      - name: Set TIMESTAMP and get REPO_NAME
        id: date
        run: |
             export DATE=$(date +'%Y%m%d-%H%M%S')
             REPO_NAME=${GITHUB_REPOSITORY#$GITHUB_REPOSITORY_OWNER/}
             echo "TIMESTAMP=$DATE" >> $GITHUB_ENV
             echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
    outputs:
      TIMESTAMP: ${{ env.TIMESTAMP }}
      REPO_NAME: ${{ env.REPO_NAME }}

######################################################
## Build and publish a staging site to GitHub Pages ##
######################################################

  configure-pages:
    runs-on: ubuntu-latest
    permissions: # read-all
      contents: read
      pages: read

    steps:
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v2
    outputs:
      base_url: ${{ steps.pages.outputs.base_url }}
      
  # Build job
  build-website:
    needs:
      - generate-timestamp
      - configure-pages
    
    runs-on: ubuntu-latest
    container:
      image: peaceiris/hugo

    env:
      HUGO_VERSION: "${{ vars.HUGO_VERSION }}" # 0.147.8 # latest  #  0.126.1 
      HUGO_FORMS: ${{ vars.HUGO_FORMS }}
      HUGO_GOOGLEANALYTICS: ${{ vars.HUGO_GOOGLEANALYTICS }}
      REPO_NAME: ${{ needs.generate-timestamp.outputs.REPO_NAME }}

    # Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
    permissions:
      contents: read
    
    steps:
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: ${{ vars.HUGO_VERSION }}
          extended: true

      - name: Pre-Build ls
        run: |
          ls -lah
          echo "${{ needs.generate-timestamp.outputs.TIMESTAMP }}" from env
          echo "${{ needs.configure-pages.outputs.base_url }}/" from env

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true  # Fetch Hugo themes (true OR recursive) # failing on ubuntu container
          fetch-depth: 0    # Fetch all history for .GitInfo and .Lastmod
          # set-safe-directory: '/__w/coastal-science.github.io/coastal-science.github.io' # The process '/usr/bin/git' failed with exit code 128
          # set-safe-directory: '/__w/${{ env.REPO_NAME }}/${{ env.REPO_NAME }}' # The process '/usr/bin/git' failed with exit code 128, resorting to manual call
          
      - name: Set safe directory workaround
        run: |
          git config --global --add safe.directory /__w/${{ env.REPO_NAME }}/${{ env.REPO_NAME }}
          
      - name: Build with Hugo
        env:
          # For maximum backward compatibility with Hugo modules
          HUGO_ENVIRONMENT: staging
          HUGO_ENV: staging
        run: |
          hugo \
            --gc \
            --buildDrafts \
            --minify \
            --baseURL "${{ needs.configure-pages.outputs.base_url }}/"
            
      - name: Post-Build ls
        run: ls -lah public/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  # Deployment job
  deploy-gh-pages:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    # Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
    permissions:
      contents: write
      id-token: write
      pages: write
    runs-on: ubuntu-latest
    needs: build-website
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

############################################
## Create and publish docker image        ##
## (handles both production and preview)  ##
############################################
  build-website-and-container-build:
    environment: docker-image
    # if: github.ref == 'refs/heads/main'
    needs:
      - generate-timestamp
    env:
      HUGO_VERSION: ${{ vars.HUGO_VERSION }} # 0.147.8 # latest  #  0.126.1 
      HUGO_FORMS: ${{ vars.HUGO_FORMS }}
      HUGO_GOOGLEANALYTICS: ${{ vars.HUGO_GOOGLEANALYTICS }}
      
      REGISTRY: ghcr.io # docker.github.sfu.ca 
      IMAGE_NAME: ${{ github.repository }}
      REPO_NAME: ${{ needs.generate-timestamp.outputs.REPO_NAME }}

    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      # This is used to complete the identity challenge
      # with sigstore/fulcio when running outside of PRs.
      id-token: write

    outputs: 
      tags: ${{ steps.meta.outputs.tags }}
      commit_sha: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
      pr_number: ${{ github.event.pull_request.number || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true  # Fetch Hugo themes (true OR recursive) # failing on ubuntu container
          fetch-depth: 0    # Fetch all history for .GitInfo and .Lastmod
          # set-safe-directory: '/__w/coastal-science.github.io/coastal-science.github.io'
          # set-safe-directory: '/__w/${{ env.REPO_NAME }}/${{ env.REPO_NAME }}' # The process '/usr/bin/git' failed with exit code 128, resorting to manual call
       
      - name: Set safe directory workaround
        run: |
          git config --global --add safe.directory /__w/${{ env.REPO_NAME }}/${{ env.REPO_NAME }}

      - name: Generate tags
        id: tags
        run: |
            # Get the current branch name
            branch_name=$(git rev-parse --abbrev-ref HEAD)
            # docker tag limit is 128 characters
            # The timestamp (YYYY_MM_DD_HH_MM_SS), commit id (7), 
            # and punctuation (additional _) take up 29 characters.
            # For 3 catalogs the branch names is can occupy the 
            # remaining characters = floor((128-29*3)/3) = 13
            branch_name=${branch_name:0:13} 

            # Get the abbreviated commit hash
            commit_hash=$(git rev-parse --short HEAD)
            
            # Get the current commit datetime (without timezone)
            commit_date=$(git show -s --format=%ci HEAD)
            # remove last five characters (timezone information)
            commit_date=${commit_date:0:${#commit_date}-5} #-5 digits causes 'expression < 0' error. Instead dynamically get the string length.
            
            # Get the current commit datetime (without timezone)
            commit_date=$(git show -s --date=format:'%Y%m%d-%H%M' --format=%cd HEAD)

            # Combine the parts into the desired format
            result="${branch_name}_${commit_hash}_${commit_date}"
            
            # remove leading/trailing spaces
            # formatted_result=$(awk '{$1=$1;print}')
            formatted_result=$(echo $result | xargs)
            # Replace spaces, colons, and dashes with underscores
            formatted_result=$(echo "$formatted_result" | sed 's/[ :\-]/_/g')
            
            #branch_name=$(echo $branch_name | xargs)
            #branch_name=$(echo "$branch_name" | sed 's/[ :\-]/_/g')
            
            commit_hash=$(echo $commit_hash | xargs)
            commit_hash=$(echo "$commit_hash" | sed 's/[ :\-]/_/g')
            
            commit_date=$(echo $commit_date | xargs)
            #commit_date=$(echo "$commit_date" | sed 's/[ :\-]/_/g')
            
            # Print the final result and return it
            echo "$formatted_result"

            #echo "branch_name=${branch_name}" >> "$GITHUB_OUTPUT"
            echo "commit_hash=${commit_hash}" >> "$GITHUB_OUTPUT"
            echo "commit_date=${commit_date}" >> "$GITHUB_OUTPUT"

      - name: List repos in workspace
        run: |
          ls -lah
          du -sh *
          echo The current workspace repo is..
          pwd

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: ${{ vars.HUGO_VERSION }}
          extended: true

      - name: Build and Minify with Hugo
        env:
          # For maximum backward compatibility with Hugo modules
          HUGO_ENVIRONMENT: ${{ github.event_name == 'pull_request' && 'preview' || 'production' }}
          HUGO_ENV: ${{ github.event_name == 'pull_request' && 'preview' || 'production' }}
        run: |
          hugo \
            --gc \
            --minify \
            --baseURL "${{ env.HUGO_BASEURL }}/"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
     
      # Login against a Docker registry except on PR
      # https://github.com/docker/login-action
      - name: Log into registry ${{ env.REGISTRY }}
        uses: docker/login-action@v3 #343f7c4344506bcbf9b4de18042ae17996df046d # v3.0.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Extract metadata (tags, labels) for Docker
      # https://github.com/docker/metadata-action
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5 #96383f45573cb7f253c731d3b3ab81c87ef81934 # v5.0.0
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} # /${{ env.SERVICE }}
          labels: |
            org.opencontainers.image.version=${{ needs.generate-timestamp.outputs.TIMESTAMP }}
          tags: |
            # branch event
            type=ref,event=branch
            # pull request event
            type=ref,event=pr,format=pr-{{number}}
            # minimal (short sha)
            type=sha
            # pull request sha with prefix
            type=sha,prefix=pr-
            # commit date tag (for branches only)
            type=raw,value=${{ steps.tags.outputs.commit_date }}
            # latest tag (for branches only)
            type=raw,value=latest

      - name: Build and push Docker image
        id: build-and-push
        uses: docker/build-push-action@v6
        env:
          HUGO_BASEURL: "${{ vars.HUGO_BASEURL }}"
        with:
          context: .
          file: Dockerfile.prod
          build-contexts: |
            public=./public
            nginx=./nginx
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          push: true

      # - name: Build website with Dockerfile.prod
      #   env:
      #     HUGO_BASEURL: "${{ vars.HUGO_BASEURL }}"
      #     ORIGINS: "${{ vars.ORIGINS }}"
      #     OAUTH_CLIENT_ID: "${{ vars.OAUTH_GITHUB_CLIENT_ID }}"
      #     OAUTH_GITHUB_CLIENT_SECRET: "${{ secrets.OAUTH_GITHUB_CLIENT_SECRET }}"
      #     CMS_BACKEND_DEBUG: ${{ vars.CMS_BACKEND_DEBUG || ''}}
          
      #   run: |
      #     echo "${{ steps.meta.outputs.labels }}"
      #     prefix="--label "
      #     LABELS=$(sed "s/^/$prefix/" <<< "${{ steps.meta.outputs.labels }}")                           
      #     echo $LABELS
      #     echo "${{ steps.meta.outputs.tags }}"
      #     docker compose -f docker-compose.yaml -f docker-compose.override.yaml build website
      #     docker tag website ${{ steps.meta.outputs.tags }}
      #     # docker tag website ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.branch_name }}
      #     docker tag website ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.commit_hash }}
      #     docker tag website ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.commit_date }}
      #     docker tag website ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          
      #     docker push --all-tags ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
  
  # Deploy docker image to orchestrator (handles both production and preview)
  deploy-service:
    # if: false
    # if: github.ref == 'refs/heads/main'
    needs:
      - generate-timestamp
      - build-website-and-container-build
    permissions:
      contents: read
      packages: read
      statuses: write
    environment: 
      name: docker-image
      url: https://${{ vars.HUGO_BASEURL }}
      # url: https://${{ vars.__SERVICE__ }}-${{ env.ENVIRONMENT == 'production' && 'latest' || 'dev' }}.ruthjoy.researchcomputinggroup.ca
    runs-on: ubuntu-latest
    # runs-on: [ self-hosted, rcg ]
    container:
      image: alpine:3.18
    env: 
      REPO_NAME: ${{ needs.generate-timestamp.outputs.REPO_NAME }}
      SERVICE: "${{ vars.__SERVICE__ }}"
      JOB_DRIVER: "${{ vars.__JOB_DRIVER__ }}"
      __REGISTRY__: ghcr.io # docker.github.sfu.ca 
      # CONTAINER_PROJECT: "coastal-science.github.io" # "rcg-containers" # repo name dynamically extracted from `github.resposity` by removing `github.owner`
      CONTAINER_PROJECT: ${{ needs.generate-timestamp.outputs.REPO_NAME }}
      # __IMAGE_NAME__="${{ secrets.REGISTRY_SERVER }}/${{ env.CONTAINER_PROJECT }}/${{ env.SERVICE }}"
      IMAGE_NAME: ${{ vars.__REGISTRY__ }}/${{ github.repository }}
      FORCE_PULL: ${{ vars.__IMAGE_FORCE_PULL__ }}
      #__DATACENTERS__="${{ secrets.NOMAD_SERVER_DATACENTERS }}" \
      # __NAMESPACE__="${{ secrets.NOMAD_SERVER_NAMESPACE }}" \
      NOMAD_SERVER_DATACENTERS: "${{ vars.__DATACENTERS__ }}"
      NOMAD_SERVER_NAMESPACE:  "${{ vars.__NAMESPACE__ }}"
      __REGISTRY_USERNAME__: "${{ github.actor }}"
      __REGISTRY_PASSWORD__: "${{ secrets.GITHUB_TOKEN }}"
      __RESEARCHER__:  "${{ secrets.__RESEARCHER__ }}"

      PR_NUMBER: ${{ github.event.pull_request.number || '' }}
      PR_SHA: ${{ github.event.pull_request.head.sha || github.sha }}

    outputs:
      prod_url: ${{ steps.set-env.outputs.prod_url }}
      nomad_url_1: ${{ steps.set-env.outputs.nomad_url }}
      url: ${{ steps.set-env.outputs.nomad_url }}
      environment_suffix: ${{ steps.set-env.outputs.environment_suffix }}
      environment: ${{ steps.set-env.outputs.environment }}

    steps:
      - name: Determine environment and suffix
        id: set-env
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            ENVIRONMENT="preview"
            ENVIRONMENT_SUFFIX="pr-${{ github.event.pull_request.number }}"
            NOMAD_FILE="${{ vars.__SERVICE__ }}-preview.nomad"
            IMAGE_TAG="pr-${{ github.event.pull_request.number }}"
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            ENVIRONMENT="production" # suspicion that the variable is unused and can be removed
            ENVIRONMENT_SUFFIX="latest"
            NOMAD_FILE="${{ vars.__SERVICE__ }}.nomad"
            IMAGE_TAG="latest" # tag should be update to `main` and use latest for any latest commit.
          else
            ENVIRONMENT="development"
            ENVIRONMENT_SUFFIX="dev"
            NOMAD_FILE="${{ vars.__SERVICE__ }}.nomad"
            # Extract branch name from refs/heads/branch-name, fallback to commit SHA
            # GITHUB_REF is automatically set by GitHub Actions (e.g., refs/heads/branch-name)
            # GITHUB_SHA is automatically set by GitHub Actions (full commit SHA)
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
            if [ -n "${BRANCH_NAME}" ] && [ "${BRANCH_NAME}" != "${GITHUB_REF}" ]; then
              IMAGE_TAG="${BRANCH_NAME}"
            else
              IMAGE_TAG="${GITHUB_SHA}"
            fi
          fi
          
          # Construct URL from Nomad template pattern: ${__SERVICE__}-${__ENVIRONMENT__}.${__RESEARCHER__}.researchcomputinggroup.ca
          NOMAD_URL="https://${{ vars.__SERVICE__ }}-${ENVIRONMENT_SUFFIX}.${{ secrets.__RESEARCHER__ }}.researchcomputinggroup.ca"
          PROD_URL="${NOMAD_URL}" # TODO: suspicion that the variable is duplicate of NOMAD_URL and can be consolidated
          
          # Determine WEB_URL based on event type
          # WEB_URL="${{ github.ref == 'refs/heads/main' && secrets.__DOMAIN_NAME__ || '' }}"
          # Determine PREVIEW_URL based on event type
          # PREVIEW_URL="${{ github.event_name == "pull_request" && NOMAD_URL || '' }}"
          WEB_URL=""
          PREVIEW_URL=""
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs
            PREVIEW_URL="${NOMAD_URL}"
          fi
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            # For production main branch
            WEB_URL="${{ secrets.__DOMAIN_NAME__ }}"
          fi
          
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "environment_suffix=${ENVIRONMENT_SUFFIX}" >> $GITHUB_OUTPUT
          echo "nomad_url=${NOMAD_URL}" >> $GITHUB_OUTPUT
          echo "web_url=${WEB_URL}" >> $GITHUB_OUTPUT
          echo "nomad_file=${NOMAD_FILE}" >> $GITHUB_OUTPUT
          echo "preview_url=${PREVIEW_URL}" >> $GITHUB_OUTPUT
          echo "prod_url=${PROD_URL}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Determined environment: ${ENVIRONMENT}, suffix: ${ENVIRONMENT_SUFFIX}, image_tag: ${IMAGE_TAG}"

      - name: Prepare Environment
        run: |
          apk update
          apk add gettext nomad git curl jq

      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true  # Fetch Hugo themes (true OR recursive) # failing on ubuntu container
          fetch-depth: 0    # Fetch all history for .GitInfo and .Lastmod
          # set-safe-directory: '/__w/coastal-science.github.io/coastal-science.github.io' # The process '/usr/bin/git' failed with exit code 128
          # set-safe-directory: '${{ env.REPO_NAME }}/${{ env.REPO_NAME }}' # The process '/usr/bin/git' failed with exit code 128, resorting to manual call

      - name: Set safe directory workaround
        run: |
          git config --global --add safe.directory /__w/${{ env.REPO_NAME }}/${{ env.REPO_NAME }}
      
      - name: Test Nomad
        run: NOMAD_TOKEN=${{ secrets.NOMAD_SERVER_TOKEN }} NOMAD_ADDR=${{ secrets.NOMAD_SERVER_ADDRESS }} nomad status

      - name: Setup Nomad Job
        id: setup-nomad
        env:
          ENVIRONMENT_SUFFIX: ${{ steps.set-env.outputs.environment_suffix }}
          ENVIRONMENT: ${{ steps.set-env.outputs.environment }}
          WEB_URL: ${{ steps.set-env.outputs.web_url }}
          NOMAD_FILE: ${{ steps.set-env.outputs.nomad_file }}
          IMAGE_TAG: ${{ steps.set-env.outputs.image_tag }}

        run: |
          # Use ENVIRONMENT_SUFFIX consistently for both PRs and branches
          JOB_NAME="${{ env.SERVICE }}-${ENVIRONMENT_SUFFIX}"
          
          __SERVICE__="${{ env.SERVICE }}" \
          __JOB_DRIVER__="${{ env.JOB_DRIVER }}" \
          __ENVIRONMENT__="${ENVIRONMENT_SUFFIX}" \
          __WEB_URL__="${WEB_URL}" \
          __JOB_NAME__="${JOB_NAME}" \
          __IMAGE_NAME__="${{ env.IMAGE_NAME }}" \
          __IMAGE_TAG__="${IMAGE_TAG}" \
          __IMAGE_FORCE_PULL__="${{ env.FORCE_PULL || 'false' }}" \
          __DATACENTERS__="${{ env.NOMAD_SERVER_DATACENTERS }}" \
          __NAMESPACE__="${{ env.NOMAD_SERVER_NAMESPACE }}" \
          envsubst < nomad/template.nomad > ${NOMAD_FILE}
          cat ${NOMAD_FILE}
          echo "nomad_file=${NOMAD_FILE}" >> $GITHUB_OUTPUT
          echo "job_name=${JOB_NAME}" >> $GITHUB_OUTPUT

      - name: Deploy TIMESTAMPED Website To Nomad
        # if: github.event_name != 'pull_request'
        id: deploy
        env:
          JOB_NAME: ${{ steps.setup-nomad.outputs.job_name }}
          NOMAD_FILE: ${{ steps.setup-nomad.outputs.nomad_file }}
        run: |
          NOMAD_TOKEN=${{ secrets.NOMAD_SERVER_TOKEN }} NOMAD_ADDR=${{ secrets.NOMAD_SERVER_ADDRESS }} \
            nomad job stop -verbose ${JOB_NAME} || true
          echo "Nomad job stop result=$?"
          sleep 10s
          NOMAD_TOKEN=${{ secrets.NOMAD_SERVER_TOKEN }} NOMAD_ADDR=${{ secrets.NOMAD_SERVER_ADDRESS }} \
            nomad job run -verbose ${NOMAD_FILE}
          DEPLOY_RESULT=$?
          echo "Nomad job deploy result=${DEPLOY_RESULT}"
          echo "deploy_success=$([ ${DEPLOY_RESULT} -eq 0 ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      - name: Create GitHub commit status for deployment
        if: github.event_name == 'pull_request'
        env:
          PREVIEW_URL: ${{ steps.set-env.outputs.preview_url }}
          DEPLOY_SUCCESS: ${{ steps.deploy.outputs.deploy_success }}
        run: |
          STATUS_URL="https://api.github.com/repos/${{ github.repository }}/statuses/${{ env.PR_SHA }}"
          
          # Determine status parameters based on deployment result
          if [ "${DEPLOY_SUCCESS}" = "true" ]; then
            STATE="success"
            TARGET_URL="${PREVIEW_URL}"
            DESCRIPTION="Preview deployment ready"
          else
            STATE="failure"
            TARGET_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            DESCRIPTION="Preview deployment failed"
          fi
          
          curl -X POST "${STATUS_URL}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "{
              \"state\": \"${STATE}\",
              \"target_url\": \"${TARGET_URL}\",
              \"description\": \"${DESCRIPTION}\",
              \"context\": \"deploy/preview\"
            }"
          
          echo "Created commit status: deploy/preview -> ${STATE} (${TARGET_URL})"

      - name: Summary output URLs
        run: |
          if [ "${{ github.event_name }}" != "pull_request" ]; then
            echo https://"${{ secrets.__DOMAIN_NAME__ }}" >> "$GITHUB_STEP_SUMMARY"
            echo "${{ steps.set-env.outputs.prod_url }}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "${{ steps.set-env.outputs.preview_url }}" >> "$GITHUB_STEP_SUMMARY"
          fi
          
  # Cleanup workspace on the runner
  cleanup:
    if: ${{ always() }}
    permissions: {}
    needs: 
      - build-website-and-container-build
      - deploy-service
    runs-on: ubuntu-latest
    # runs-on: [ self-hosted, rcg ]
    steps:
      - name: Current workspace
        run: du -shc ${GITHUB_WORKSPACE}
      - name: Clean Up Docker Images
        if: needs.build-website-and-container-build.result != 'skipped'
        run: docker rmi -f $(docker images '${{ needs.build-website-and-container-build.outputs.tags }}' -a -q) || echo "No docker images found to remove...skipping removal."
      - name: Clean Up Workspace
        run: rm -rf ${GITHUB_WORKSPACE}
